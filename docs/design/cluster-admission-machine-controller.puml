@startuml cluster-admission-machine-controller

start;
:Machine controller;

repeat
  :Machine controller enqueues a Create call;
  :Get control plane machines for cluster;
  if (A control plane machine is ready) then (yes)
    if (Machine has control plane role) then (yes)
      #LightBlue:Join as control plane member;
    else (no)
      #LightBlue:Join as worker node;
    endif
  else (no)
    if (Machine has control plane role) then (yes)
      :Create control plane config map;
      if (Control plane config map already exists) then (yes)
        #Pink:Return RequeueError;
      else (no)
        #LightBlue:Init control plane;
        #LightBlue:Set ready status on Machine annotation;
        #LightBlue:Patch Machine back to API server;
        #LightBlue:Delete control plane config map;
      endif
    else (no)
      #Pink:Return RequeueError;
    endif
  endif
repeat while (Create returned RequeueError) is (yes)
-> no;
if (Create returned error) then (yes)
  #Pink:Error creating machine;
else (no)
  #LightBlue:Machine has initialized or joined the cluster;
endif
stop;

@enduml